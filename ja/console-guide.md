## Network > Peering Gateway > コンソール使用ガイド

コンソールでPeering Gatewayサービスを使用する方法を説明します。

## ピアリング

**ピアリング**は、2つの異なる**VPC**を接続する機能です。通常、VPCはネットワーク領域が異なるため通信ができません。**Floating IP**を利用して接続できますが、ネットワーク使用量に応じて追加費用を支払う必要があります。しかし、ピアリング機能を使えば追加費用を支払わずに2つの**VPC**を接続できます。

* ピアリングは、2つの異なるVPCを接続します。VPCを経由してまた別のVPCへの接続はサポートしません。 `A <-> B <-> C`接続で`A`と`C`は接続できません。
* ピアVPCを経由して別のVPCに接続したい場合は、ピアリングで提供される**ルート**設定を利用してVMインスタンスを経由してパケットが転送されるように設定する必要があります。
  > [参考]ルートの使い方は、以下の「共通機能 > ルート」の内容を参照してください。 
* 2つのVPCのIPアドレス領域が重なる場合は使用できません。<br>
  IPアドレス領域の一方がもう一方と包含関係にならないようにしてください。その場合、ピアリングの作成に失敗します。
* 韓国リージョンを除く他のリージョンでは**基本ルーティングテーブル**に接続されていないサブネットでのみ通信が可能です。
    > [参考]ピアリングを作成すると、基本ルーティングテーブルにピアリング通信をルーティングするために、相手VPCのIPアドレス範囲に向かうパケットをピアリングゲートウェイに伝達するルーティングルールが黙示的に追加されます。したがって、基本ルーティングテーブルに相手VPCのIPアドレス範囲をCIDRとする他のルートを設定することはできません。また、相手VPCのIPアドレス範囲内の一部をCIDRに指定するルートを追加した場合、ピアリング通信用のルートより優先順位が高く、ピアリング通信ができないことがあるため注意が必要です。
* 韓国リージョンはピアリングを作成した後、ピアリングした両方のVPCのルーティングテーブルに別途のルートを設定すると通信が可能です。
    * ルートの**対象CIDR**に相手VPCのIPアドレス領域を入力し、ゲートウェイリストでピアリングの名前を持つ**PEERING**項目を選択してルートを追加します。
    * ルートを追加したルーティングテーブルに接続されたサブネットでのみ通信が可能です。
    * 基本ルーティングテーブルではないルーティングテーブルもルートを追加すると、ルーティングテーブルに接続されたサブネットで通信が可能です。
 * ピアリング作成時、サブネットがないVPCを指定するとピアリングの作成に失敗します。

### ピアリング作成

1. **Network > Peering Gateway > ピアリング**に移動します。
2. **ピアリング作成**ボタンをクリックします。
3. **名前**、**説明**を入力し、**ローカルVPC**、**ピアVPC**を選択後、**確認**ボタンをクリックします。

### ピアリングの変更

1. **Network > Peering Gateway > ピアリング**に移動します。
2. ピアリングリストで変更するピアリングを選択します。
3. **ピアリングの変更**ボタンをクリックします。
4. ピアリングの**名前**または**説明**を変更し、**確認**ボタンをクリックします。

### ピアリングの削除

1. **Network > Peering Gateway > ピアリング**に移動します。
2. ピアリングリストから削除するピアリングを選択します。
3. **ピアリング削除**ボタンをクリックします。

## リージョンピアリング

**リージョンピアリング**は異なるリージョンに作成された2つの**VPC**を接続する機能です。同じリージョンのVPCはピアリングを利用して接続できますが、リージョンが異なるVPCを接続することはできません。しかし、リージョンピアリングを利用するとリージョンが異なる2つのVPCを接続できます。

* リージョンピアリングは、2つの異なるリージョンVPCを接続します。別のVPCを経由してまた別のVPCへの接続はサポートしません。例えば`A <-> B <-> C`接続で`A`と`C`は接続できません。
* ピアVPCを経由して別のVPCに接続したい場合は、ピアリングで提供される**ルート**設定を利用してVMインスタンスを経由してパケットが転送されるように設定する必要があります。
  > [参考]ルートの使い方は、以下の「共通機能 > ルート」の内容を参照してください。 
* 同じプロジェクト、異なるプロジェクトともに接続できます。
* リージョンピアリングを作成すると、接続された他のリージョンで自動的に作成されます。
* リージョンピアリングを削除すると、接続された他のリージョンで自動的に削除されます。
* 2つのVPCのIPアドレス領域が重なる場合は使用できません。
* 重複したVPC接続は作成できません。
* ピアリングされた両方のVPCの**ルーティングテーブル**に別の**ルート**を設定すると通信が可能です。
    * ルートの**対象CIDR**に相手VPCのIPアドレス領域を入力し、ゲートウェイリストでリージョンピアリングの名前を持つ**INTER_REGION_PEERING**項目を選択してルートを追加します。
    * ルートを追加したルーティングテーブルに接続されたサブネットでのみ通信が可能です。
    * 基本ルーティングテーブルではないルーティングテーブルにルートを追加すると、ルーティングテーブルに接続されたサブネットでピアリング通信が可能です。
    * リージョンピアリング作成時、サブネットがないVPCを指定すると、リージョンピアリングは作成に失敗します。

### リージョンピアリングの作成

> [参考]<br>
> 他のプロジェクト間でリージョンピアリングを作成するには、ピアプロジェクトのピアリング許可対象管理で自分のプロジェクトのテナントIDとVPC IDが許可されている必要があります。同じプロジェクト内でリージョンピアリングを作成する場合は必要ありません<br>。
> 他のプロジェクト間でリージョンピアリングを作成する前に、ピアプロジェクトの管理者にテナントIDとVPC IDを伝え、ピアリング許可対象管理に情報登録を要請する必要があります。<br>
> ピアプロジェクトで情報登録が完了したら、次の手順でプロジェクトピアリングを作成できます。<br>
> ピアリング許可対象管理の使用方法は、下記の**共通機能** > ピアリング許可対象管理**の項目を参照してください。

1. **Network > Peering Gateway > リージョンピアリング**に移動します。
2. **リージョンピアリング作成**ボタンをクリックします。
3. **名前**、**ローカルVPC**、**ピアリージョン**を選択します。
4. **ピアテナント**を選択します。
    * **同じテナント**を選択した場合、追加で入力する事項はありません。
    * **他のテナント**を選択した場合は、**ピアテナントID**を入力する必要があります。
   > [参考]ピアテナントID<br>
   > ピアテナントIDは、下部の「参考資料」項目をご参照ください。
6. **ピアVPC ID**を入力します。</br>
   > [参考]ピアVPC ID<br>

   > ピアテナントIDは、下部の「参考資料」項目をご参照ください。
   
### リージョンピアリング削除

1. **Network > Peering Gateway > リージョンピアリング**に移動します。
2. ピアリングリストから削除するリージョンピアリングを選択します。
3. **リージョンピアリング削除**ボタンをクリックします。

## プロジェクトピアリング

**プロジェクトピアリング**は、異なるプロジェクトに作成された2つの**VPC**を接続する機能です。同じプロジェクトのVPCはピアリングを利用して接続できますが、プロジェクトが異なるVPCを接続することはできません。しかし、プロジェクトピアリング機能を利用するとプロジェクトが異なる2つのVPCを接続できます。

* プロジェクトピアリングは、2つの異なるプロジェクトのVPCを接続します。別のVPCを経由してまた別のVPCへの接続はサポートしません。例えば`A <-> B <-> C`接続で`A`と`C`は接続できません。
* ピアVPCを経由して別のVPCに接続したい場合は、ピアリングで提供される**ルート**設定を利用してVMインスタンスを経由してパケットが転送されるように設定する必要があります。
  > [参考]ルートの使い方は、以下の「共通機能 > ルート」の内容を参照してください。 
* 同じリージョンで異なるプロジェクトの2つのVPCのみ接続が可能です。
* プロジェクトピアリングを作成すると、接続された別のプロジェクトで自動的に作成されます。
* プロジェクトピアリングを削除すると、接続された別のプロジェクトで自動的に削除されます。
* 2つのVPCのIPアドレス領域が重なる場合は使用できません。
* 重複したVPC接続は作成できません。
* ピアリングされた両方のVPCの**ルーティングテーブル**に別の**ルート**を設定すると通信が可能です。
    * ルートの**対象CIDR**に相手VPCのIPアドレス領域を入力し、ゲートウェイリストからプロジェクトピアリングの名前を持つ**INTER_PROJECT_PEERING**項目を選択してルートを追加します。
        * ルートを追加したルーティングテーブルに接続されたサブネットでのみ通信が可能です。
    * 基本ルーティングテーブルではないルーティングテーブルにルートを追加すると、ルーティングテーブルに接続されたサブネットでピアリング通信が可能です。
    * プロジェクトピアリング作成時、サブネットがないVPCを指定するとプロジェクトピアリングは作成に失敗します。

### プロジェクトピアリングの作成

> [参考]<br>
> プロジェクトピアリングを作成するには、ピアプロジェクトのピアリング許可対象管理で自分のプロジェクトのテナントIDとVPC IDが許可されている必要があります。<br>
> プロジェクトピアリングを作成する前に、ピアプロジェクトの管理者にテナントIDとVPC IDを伝え、ピアリング許可対象管理に情報登録を要請する必要があります。<br>
> ピアプロジェクトで情報登録が完了したら、次の手順でプロジェクトピアリングを作成できます。<br>
> ピアリング許可対象管理の使用方法は、以下の「共通機能 > ピアリング許可対象管理」の項目を参照してください。

1. **Network > Peering Gateway > プロジェクトピアリング**に移動します。
2. **プロジェクト間ピアリング作成**ボタンをクリックします。
3. **名前**、**ローカルVPC**、**ピアリージョン**、**ピアテナントID**、**ピアVPC ID**を入力します。</br>
   > [参考]ピアテナントID、ピアVPC ID <br>
   > ピアテナントIDとピアVPC IDの確認方法は、下部の「参考資料」項目をご参照ください。

### プロジェクトピアリングの削除

1. **Network > Peering Gateway > プロジェクトピアリング**に移動します。
2. ピアリングリストから削除するプロジェクトピアリングを選択します。
3. **プロテクトピアリングの削除**ボタンをクリックします。

## 共通機能

ピアリング(ピアリング、リージョンピアリング、プロジェクトピアリング)で提供する共通機能を説明します。

### ピアリング許可対象の管理

リージョンピアリング、プロジェクトピアリングページのサブメニューで、他のプロジェクト間のピアリング接続要求を受ける側で設定できます。リクエストを送信するVPCのピアテナントIDとピアVPC IDを入力してピアリング許可VPCに追加し、ピアが送信するリクエストを受け入れることができるようにします。

#### ピアリング許可対象の追加

1. **Network > Peering Gateway > リージョンピアリング**または **Network > Peering Gateway > プロジェクトピアリング**に移動します。
2. **ピアリング許可対象の管理**ボタンをクリックします。
3. **ピアリング許可VPC追加**ボタンをクリックします。
4. **名前**、**ピアテナントID**、**ピアVPC ID**を入力し、確認ボタンをクリックします。</br>
   > [参考]ピアテナントID、ピアVPC ID <br>
   > ピアテナントIDとピアVPC IDの確認方法は、下の「参考資料」の項目を参照してください。

#### ピアリング許可対象の削除

1. **Network > Peering Gateway > リージョンピアリング**または **Network > Peering Gateway > プロジェクトピアリング**に移動します。
2. **ピアリング許可対象の管理**ボタンをクリックします。
3. ピアリング許可VPCリストから削除する対象の削除ボタンをクリックします。

### ルート

ピアリングで提供する**ルート**設定を利用すると、ピアVPCのVMインスタンスを経由して他のVPCにトラフィックを転送するように構成できます。ピアリングのルートはピアリングから流入したすべてのトラフィックを処理するVMインスタンスのポートおよび仮想IPポートを指定して設定できます。ルートのゲートウェイとなるVMインスタンスにはNetwork Virtual Appliance VMをバッチしてVMインスタンス内部でトラフィックを制御し、他のピアリングにトラフィックを転送できます。
* ピアリングでハブ&スポーク(Hub & Spoke)形式のVPC接続を構成し、ハブVPCにあるNetwork Virtual Applianceですべてのトラフィックを制御したい構成はピアリングのルーティング機能を活用して構成できます。

#### ルート作成

1.ルート設定を行いたいアリングに選択します。
2.下部のタブでルートを選択します。
3. **ルート変更**を選択します。
   > [参考]ピアリングの場合、2つのボタンが存在します。ピアルートの変更は、ピアリング作成時に選択したピアVPCにルートを追加するもので、ローカルルート変更はローカルVPCの位置を意味します。<br>
4. **+**ボタンをクリックします。
5. 対象CIDRを入力します。
6. ゲートウェイを選択します。
   > [参考]ゲートウェイはインスタンスと仮想IPのみ選択が可能です。<br>
7. **確認**ボタンをクリックします。

#### ルートの削除

1. ルート設定を削除したいピアリングを選択します。
2.下部のタブでルートを選択します。
3. **ルート変更**ボタンをクリックします。
   > [参考]ピアリングの場合、2つのボタンが存在します。ピアルートの変更は、ピアリング作成時に選択したピアVPCにルートを追加するもので、ローカルルート変更はローカルVPCの位置を意味します。<br>
4.削除対象の**-**ボタンをクリックします。
5. **確認**ボタンをクリックします。

## 参考資料

### ピアVPC IDの確認方法

次の手順でピアの**VPC ID**を確認できます。

> [参考]ピアVPCが属するプロジェクトにアクセス権がない場合、ピアプロジェクトの管理者にVPC IDを提供してもらってください。

1. ピアプロジェクトのコンソール画面に接続します。
2. **Network > VPC > 管理**に移動します。
3. ピアリング対象VPCを選択します。
4. **基本情報 > VPC名**に表記されたUUID値をコピーします。

### ピアテナントIDの確認方法

次の手順でピアの**テナントID**を確認できます。

> [参考]ピアプロジェクトにアクセス権限がない場合、ピアプロジェクトの管理者にテナントIDを提供してもらってください。

1. ピアプロジェクトのコンソール画面に接続します。
2. **Network > VPC > 管理**に移動します。
3.ピアリング対象または画面に表示されるVPCの中から1つを選択します。
4. **基本情報 > テナントID**に表記されたID値をコピーします。
